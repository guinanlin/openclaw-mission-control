# OpenClaw Mission Control 本地开发指南

本文说明如何在本地跑起 Mission Control 做开发（热重载、调试、跑测试）。

---

## 一、两种跑法概览

| 方式 | 适用场景 | 依赖 |
|------|----------|------|
| **Docker 全栈** | 快速体验、联调、不打算改代码 | Docker + Docker Compose |
| **本地开发（推荐）** | 改后端/前端代码、热重载、调试 | Node.js、uv（Python）、Docker（仅 db/redis） |

---

## 二、方式 A：Docker 全栈（一键跑起）

适合：只想先把整站跑起来，不打算在本地改代码。

### 1. 环境要求

- Docker Engine
- Docker Compose v2（`docker compose`）

### 2. 配置与启动

```bash
cd openclaw-mission-control

# 复制环境并配置
cp .env.example .env
```

**必须修改 `.env`：**

- `LOCAL_AUTH_TOKEN`：设为至少 50 字符的非占位符字符串（`AUTH_MODE=local` 时必填）
- `NEXT_PUBLIC_API_URL`：浏览器能访问到的后端地址，本地一般为 `http://localhost:8000`

然后启动：

```bash
docker compose -f compose.yml --env-file .env up -d --build
```

### 3. 访问

- 前端：http://localhost:3000  
- 后端健康检查：http://localhost:8000/healthz  

### 4. 停止

```bash
docker compose -f compose.yml --env-file .env down
```

---

## 三、方式 B：本地开发（推荐做代码开发）

适合：在本地改 backend / frontend，需要热重载和调试。

思路：**只用 Docker 跑数据库（和 Redis）**，backend 和 frontend 在宿主机用 `uv` / `npm` 跑，便于改代码、看日志、断点。

### 1. 环境要求

- **Node.js**（建议 18+，install.sh 的 local 模式要求 22+）
- **Python 3.12+**
- **uv**：<https://github.com/astral-sh/uv>（推荐，项目用 uv 管理后端依赖）
- **Docker**：只用来跑 Postgres（和可选 Redis）

### 2. 一键初始化（可选）：用安装脚本

若已克隆仓库，在仓库根目录执行：

```bash
./install.sh
```

选择：

- **Deployment mode**：选 `local`
- **Database source**：选 `docker`（用 Docker 起 Postgres）或 `external`（已有 Postgres 则填 `DATABASE_URL`）
- **LOCAL_AUTH_TOKEN**：选自动生成或手动输入（至少 50 字符）
- **Start backend/frontend after bootstrap**：选 `yes` 会帮你起 backend + frontend（后台进程）

脚本会：生成/写入 `.env`、`backend/.env`、`frontend/.env`，执行 `make setup`、迁移、前端构建，并可选择启动后端和前端。

### 3. 手动本地开发步骤（不用 install.sh 时）

在仓库根目录 `openclaw-mission-control` 下操作。

#### 3.1 根目录环境

```bash
cp .env.example .env
```

编辑 `.env`，至少保证：

- `LOCAL_AUTH_TOKEN` = 至少 50 字符的字符串
- `NEXT_PUBLIC_API_URL=http://localhost:8000`

#### 3.2 只起数据库（和 Redis，可选）

```bash
# 只起 db（和 redis，compose 里是一起的）
docker compose -f compose.yml --env-file .env up -d db redis
```

如需后台任务（RQ），需要 redis；只做 API 调试可以暂时不关心 redis。

#### 3.3 后端（Backend）

```bash
cd backend
cp .env.example .env
```

确认 `backend/.env` 里：

- `DATABASE_URL=postgresql+psycopg://postgres:postgres@localhost:5432/mission_control`（和 compose 里 Postgres 一致）
- `CORS_ORIGINS=http://localhost:3000`
- `AUTH_MODE=local`
- `LOCAL_AUTH_TOKEN` 与根目录 `.env` 中一致（至少 50 字符）
- 若要用自动迁移：`DB_AUTO_MIGRATE=true`（否则可 `false`，需要时再 `make backend-migrate`）

安装依赖并启动（带热重载）：

```bash
uv sync --extra dev
uv run uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

验证：`curl -f http://localhost:8000/healthz`

#### 3.4 前端（Frontend）

新开一个终端：

```bash
cd frontend
cp .env.example .env
```

确认 `frontend/.env` 里：

- `NEXT_PUBLIC_API_URL=http://localhost:8000`
- `NEXT_PUBLIC_AUTH_MODE=local`

安装依赖并启动开发服务器：

```bash
npm install
npm run dev
```

浏览器打开：http://localhost:3000

#### 3.5 数据库迁移（若未自动执行）

在仓库根目录：

```bash
make backend-migrate
```

或在 backend 目录：

```bash
cd backend
uv run alembic upgrade head
```

---

## 四、开发时常用命令（仓库根目录）

| 命令 | 说明 |
|------|------|
| `make help` | 查看所有 make 目标 |
| `make setup` | 安装 backend + frontend 依赖 |
| `make backend-migrate` | 执行数据库迁移 |
| `make backend-format` | 后端代码格式化 |
| `make frontend-format` | 前端代码格式化 |
| `make lint` | 后端 + 前端 lint |
| `make typecheck` | 后端 + 前端类型检查 |
| `make test` | 后端 + 前端测试 |
| `make check` | 与 CI 最接近：lint + typecheck + 测试 + 构建 |
| `make backend-migration-check` | 校验迁移图（CI 门禁） |

---

## 五、API 客户端生成（前端调用后端 OpenAPI）

若改了后端 API，需要重新生成前端的 TS 客户端：

1. 确保后端已在本机运行（例如 `http://127.0.0.1:8000`）。
2. 在仓库根目录执行：

```bash
make api-gen
```

或进入 frontend 目录执行：

```bash
cd frontend
npm run api:gen
```

---

## 六、后台任务队列（RQ Worker，可选）

若功能涉及异步任务，需要 Redis + RQ worker。Docker 已起 redis 时，在仓库根目录另开终端：

```bash
make rq-worker
```

或：

```bash
cd backend && uv run python ../scripts/rq worker
```

确保 `backend/.env` 中 `RQ_REDIS_URL=redis://localhost:6379/0`（与 compose 里 redis 端口一致）。

---

## 七、常见问题

- **前端请求后端跨域**：检查 `backend/.env` 的 `CORS_ORIGINS` 包含前端地址（如 `http://localhost:3000`）。
- **后端连不上数据库**：确认 `docker compose ... up -d db` 已执行，且 `backend/.env` 的 `DATABASE_URL` 使用 `localhost` 和 compose 暴露的端口（默认 5432）。
- **LOCAL_AUTH_TOKEN 无效**：必须至少 50 字符，且根目录 `.env` 与 `backend/.env` 中一致；登录/调试时在 UI 或请求头里使用该 token。

更多排错见：[Troubleshooting](./troubleshooting/README.md)。
