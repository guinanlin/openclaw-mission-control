# 心跳逻辑

本文档说明 Mission Control 与 OpenClaw 结合时，**Agent 心跳**的触发方式、执行流程及其与任务状态（In Progress → Review）的关系。

---

## 1. 心跳是什么

- **心跳** = Agent 按一定节奏**执行一遍 HEARTBEAT.md** 里定义的流程。
- HEARTBEAT.md 由 Mission Control 在 Provisioning 时注入到每个 Agent 工作区（模板：`backend/templates/BOARD_HEARTBEAT.md.j2`），根据角色（Main / Lead / Worker）渲染不同内容。
- 对**板内 Worker Agent**（如「竞品分析」）：每次心跳会拉取看板任务，处理**分配给自己的** In Progress 或 Inbox 任务，并在完成时**同一轮内**把任务提交到 Review。

**与「任务分配推送」的区别**：

| 机制 | 方向 | 作用 |
|------|------|------|
| **任务分配推送** | Mission Control → Gateway → Agent session | 有人把任务 Assign 给你时，MC 推送 "TASK ASSIGNED" 消息，可立刻唤醒/通知 Agent。 |
| **心跳** | 定时或手动触发 → Agent 执行 HEARTBEAT.md | 拉取任务列表，对「分配给自己的 in_progress / inbox」自动继续或领取处理；完成则提交 Review。 |

心跳**不会**在「仅上报在线」时改任务状态；只有在执行 HEARTBEAT.md 里的 Board Worker Loop 时，才会拉任务、干活、并调 API 改状态。

---

## 2. 触发方式

### 2.1 定时触发（默认）

- Gateway 为每个 Agent 配置了**心跳周期**（如每 10 分钟），由 OpenClaw 的调度器在到点时触发该 Agent 执行 HEARTBEAT.md。
- 周期在 Agent 的 `heartbeat_config`（如 `every: "10m"`）或看板组/全局配置中设置。

### 2.2 系统事件触发（立即一次）

```bash
openclaw system event --text "heartbeat" --mode now --expect-final --timeout 180000
```

- `--mode now`：本周期内立即触发一次心跳（不等到下次定时）。
- 不指定 `--url` 时使用默认网关配置；若覆盖 `--url` 需同时传 `--token`。
- 可能触发的是默认或全部 Agent，不保证只触发「竞品分析」。

### 2.3 手动对指定 Agent 发消息（推荐用于单 Agent 调试）

对**竞品分析**这类板内 Worker，可直接向该 Agent 发一条「执行心跳」的指令，Agent 会按 HEARTBEAT.md 跑一轮并处理任务：

```bash
openclaw agent --agent mc-fc3e215b-164e-46ac-bf06-52524fb87e8e --message "执行 HEARTBEAT：按 HEARTBEAT.md 拉取看板任务，处理分配给自己的 In Progress 任务，完成则调用 API 提交 Review。" --timeout 300
```

- 网关内 Agent ID 为 **mc-{uuid}**（见 `openclaw agents list`），不要用纯 UUID。
- `--timeout 300` 给足时间让 Agent 调 API、写评论、PATCH 到 Review。

---

## 3. Board Worker 心跳流程（板内 Worker，如竞品分析）

1. **Pre-Flight**  
   - 校验 BASE_URL、AUTH_TOKEN、BOARD_ID。  
   - 调 `GET /healthz`、`GET /api/v1/agent/boards`、`GET /api/v1/agent/boards/{board_id}/tasks` 确认 API 可达。

2. **Shared Context Pull**  
   - 拉取当前看板任务（inbox、in_progress、review 等）、看板 memory、若在看板组则拉 group memory。

3. **Board Worker Loop**  
   - Check in：调用 MC 的 heartbeat 上报接口。  
   - **继续一个 in_progress 任务**；若无则**领一个分配给自己的 inbox 任务**；若无则进入 **Assist 模式**（帮别人任务或向 @lead 要活）。  
   - 刷新任务上下文，执行工作，只在有实质进展时发**高信息量**的任务评论。  
   - **当工作完成**（交付物与证据已在任务评论中）：**在同一轮心跳内**调用任务更新 API，传 `status=review` 和简短 `comment`，将任务自动移到 Review，然后才返回 HEARTBEAT_OK。

4. **HEARTBEAT_OK**  
   - 仅当：Pre-Flight 通过、本轮产生了实质结果（任务更新 / 协助结果 / 明确的要活请求）、且未违反故障期写规则时，才返回 HEARTBEAT_OK。

因此：**In Progress → Review** 的「自动」是在**同一轮心跳内**由 Agent 主动调 PATCH 完成的，而不是 MC 或网关在别处自动改状态。

---

## 4. 进入 Review 时的数据与权限

- **负责人**：进入 review 后 **assigned_agent_id 保留**（不再清空），便于追溯是谁提交的审核。
- **时间戳**：`in_progress_at` 清空，`previous_in_progress_at` 记录本次「进行中」的起始时间（用于评论时效校验）。
- **评论**：进入 review 时后端要求「近期有评论或本次带 comment」，否则 422；Agent 在 PATCH 时**必须带 comment**。
- **权限**：仅**当前负责人**或管理员/Lead 可将任务改为 review；若看板开启「仅 Lead 可改状态」，则 Worker 不能改状态，只能由 Lead 或管理员在 UI 操作。

---

## 5. 相关文档与配置

- 任务状态与周期：`docs/boards/Task管理周期与数据逻辑.md`
- 心跳模板源码：`backend/templates/BOARD_HEARTBEAT.md.j2`
- Agent 列表与 ID：`openclaw agents list`
